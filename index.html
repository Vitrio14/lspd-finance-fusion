<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSPD - Gestione Finanze & Risorse</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Barlow+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --police-blue: #0055ff; --police-dark: #001133; --police-accent: #ffd700;
            --terminal-bg: #05070a; --border-blue: #0055ff; --neon-glow: rgba(0, 85, 255, 0.4);
            --danger: #ff4444; --success: #00ff88; --warning: #ffaa00;
            --info: #00d4ff;
        }

        body {
            background-color: var(--terminal-bg);
            background: linear-gradient(rgba(5, 7, 10, 0.95), rgba(5, 7, 10, 0.95)), url('./banner.png') no-repeat center center fixed;
            background-size: cover; color: #ffffff; font-family: 'Barlow Condensed', sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        .container { width: 95%; max-width: 1200px; background: rgba(13, 17, 23, 0.95); border: 1px solid var(--border-blue); padding: 25px; margin: 20px 0; backdrop-filter: blur(10px); box-shadow: 0 0 20px var(--neon-glow); flex-grow: 1; }
        .hidden { display: none !important; }
        
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .modal-card { background: var(--police-dark); border: 2px solid var(--police-blue); padding: 30px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 0 30px var(--police-blue); overflow-y: auto; max-height: 90vh; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--police-dark); border-left: 4px solid var(--police-blue); color: white; padding: 15px 25px; margin-bottom: 10px; font-family: 'Orbitron'; font-size: 0.7rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--police-blue); padding-bottom: 10px; }
        .tab-btn { background: none; border: 1px solid var(--police-blue); color: white; padding: 10px 20px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; transition: 0.3s; }
        .tab-btn.active { background: var(--police-blue); color: #000; font-weight: bold; }

        .stat-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgba(0, 85, 255, 0.1); border: 1px solid var(--police-blue); padding: 15px; text-align: center; box-shadow: inset 0 0 10px rgba(0, 85, 255, 0.2); }
        .stat-val { font-family: 'Orbitron'; font-size: 1.5rem; color: var(--police-accent); display: block; text-shadow: 0 0 10px var(--police-accent); }
        .stat-lab { font-size: 0.6rem; letter-spacing: 2px; color: #aaa; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; font-family: 'Orbitron'; }
        .badge-operativo { background: rgba(0, 255, 136, 0.2); color: var(--success); border: 1px solid var(--success); }
        .badge-riparazione { background: rgba(255, 170, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .badge-rimosso { background: rgba(255, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .badge-distrutto { background: #444; color: #eee; border: 1px solid #fff; }

        .search-box { background: rgba(0,0,0,0.5); border: 1px solid var(--police-blue); color: white; padding: 12px; width: 100%; box-sizing: border-box; font-family: 'Orbitron'; font-size: 0.75rem; margin-bottom: 15px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(0, 85, 255, 0.3); padding: 20px; position: relative; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { font-family: 'Orbitron'; font-size: 0.65rem; color: var(--police-accent); border-bottom: 2px solid var(--police-blue); padding: 15px 10px; text-align: left; background: rgba(0,0,0,0.3); }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(0, 85, 255, 0.08); cursor: pointer; }

        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; text-align: left; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { color: var(--police-accent); font-family: 'Orbitron'; font-size: 0.6rem; margin-bottom: 5px; letter-spacing: 1px; }
        input, select { background: #000; border: 1px solid var(--police-blue); color: #fff; padding: 10px; font-family: 'Barlow Condensed'; font-size: 1rem; }
        
        button { background: var(--police-dark); color: white; border: 1px solid var(--police-blue); padding: 10px; font-family: 'Orbitron'; cursor: pointer; font-size: 0.7rem; transition: 0.3s; }
        button:hover { background: var(--police-blue); box-shadow: 0 0 10px var(--police-blue); color: #000; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-success { border-color: var(--success); color: var(--success); }

        footer { 
            width: 100%; padding: 25px 0; text-align: center; background: rgba(0, 10, 30, 0.8);
            border-top: 1px solid var(--police-blue); box-shadow: 0 -5px 20px var(--neon-glow);
            margin-top: auto; font-family: 'Orbitron'; font-size: 0.65rem; color: rgba(255,255,255,0.6); letter-spacing: 2px;
        }

        .main-header { display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid var(--police-blue); padding-bottom: 20px; margin-bottom: 20px; position: relative; }
        .logout-btn-header { position: absolute; right: 0; top: 50%; transform: translateY(-50%); }

        @media (max-width: 768px) { .logout-btn-header { position: relative; top: 0; transform: none; margin-top: 15px; } }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="modalOverlay" class="hidden">
    <div class="modal-card">
        <h2 id="modalTitle" style="font-family:'Orbitron'; font-size:1rem; color:var(--police-accent); margin-bottom:20px;">SISTEMA</h2>
        <div id="modalBody" style="margin-bottom:25px;"></div>
        <div id="modalActions" style="display:flex; gap:10px; justify-content: center;"></div>
    </div>
</div>

<div id="authSection" class="container" style="max-width:400px; text-align:center; margin-top:50px; flex-grow: 0;">
    <img src="./logo.png" alt="LSPD" style="width:100px; margin-bottom:20px; filter: drop-shadow(0 0 10px var(--police-blue));">
    <h2 style="font-family:'Orbitron'; font-size:1rem; color:var(--police-accent); letter-spacing: 2px;">GESTIONE FINANZE & RISORSE</h2>
    <form id="loginForm">
        <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required placeholder="esempio@email.com"></div>
        <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required placeholder="••••••••"></div>
        <button type="submit" style="width:100%;">EFFETTUA IL LOGIN</button>
    </form>
</div>

<div id="mainApp" class="container hidden">
    <div class="main-header">
        <img src="./logo.png" alt="LSPD" style="width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 5px var(--police-blue));">
        <div style="text-align: center;">
            <h1 style="font-family:'Orbitron'; font-size:1.5rem; margin:0; color:var(--police-blue);">GESTIONE FINANZE & RISORSE</h1>
            <div id="clock" style="color:var(--police-accent); font-family:'Orbitron'; font-size:0.7rem;">00:00:00</div>
        </div>
        <button onclick="logout()" class="btn-danger logout-btn-header">LOGOUT</button>
    </div>

    <div class="stat-bar">
        <div class="stat-card">
            <span class="stat-lab">SALDO ATTUALE DIPARTIMENTO</span>
            <span class="stat-val" id="total_balance">$ 0</span>
        </div>
        <div class="stat-card">
            <span class="stat-lab">USCITE TOTALI (STIPENDI)</span>
            <span class="stat-val" id="total_expenses" style="color: var(--danger); text-shadow: 0 0 10px var(--danger);">$ 0</span>
        </div>
        <div class="stat-card">
            <span class="stat-lab">VEICOLI REGISTRATI</span>
            <span class="stat-val" id="total_vehicles">0</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('veicoli')">GESTIONE VEICOLI</button>
        <button class="tab-btn" onclick="switchTab('stipendi')">GESTIONE STIPENDI</button>
        <button class="tab-btn" onclick="switchTab('gestione')" style="border-color:var(--police-accent)">GESTIONE FONDI</button>
    </div>

    <div id="tab-veicoli" class="tab-content">
        <div class="dashboard-grid">
            <div class="card">
                <h3 style="font-family:'Orbitron'; font-size:0.75rem; color:var(--police-accent);">[+] REGISTRAZIONE VEICOLO</h3>
                <form id="veicoloForm">
                    <div class="form-group"><label>Modello</label><input type="text" id="v_modello" required placeholder="Esempio: Vapid Interceptor"></div>
                    <div class="form-group"><label>Targa</label><input type="text" id="v_targa" required placeholder="LSPD-001"></div>
                    <div class="form-group"><label>Agente Responsabile</label><input type="text" id="v_agente"></div>
                    <div class="form-group">
                        <label>Stato Operativo</label>
                        <select id="v_stato">
                            <option value="OPERATIVO">OPERATIVO</option>
                            <option value="IN RIPARAZIONE">IN RIPARAZIONE</option>
                            <option value="RIMOSSO">RIMOSSO</option>
                            <option value="DISTRUTTO">DISTRUTTO</option>
                        </select>
                    </div>
                    <button type="submit" style="width:100%">AGGIUNGI ASSEGNAZIONE VEICOLO</button>
                </form>
            </div>
            <div class="card" style="grid-column: span 2;">
                <input type="text" class="search-box" placeholder="FILTRA VEICOLI PER TARGA O AGENTE..." onkeyup="filterTable('veicoliBody', this.value)">
                <table>
                    <thead><tr><th>MODELLO</th><th>TARGA</th><th>AGENTE RESP.</th><th>STATO</th><th>AZIONI</th></tr></thead>
                    <tbody id="veicoliBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-stipendi" class="tab-content hidden">
        <div class="dashboard-grid">
            <div class="card">
                <h3 style="font-family:'Orbitron'; font-size:0.75rem; color:var(--police-accent);">[+] REGISTRA PAGAMENTO</h3>
                <form id="stipendioForm">
                    <div class="form-group"><label>Agente Ricevente</label><input type="text" id="s_agente" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>Dal</label><input type="date" id="s_dal" required></div>
                        <div class="form-group"><label>Al</label><input type="date" id="s_al" required></div>
                    </div>
                    <div class="form-group">
                        <label>Grado (Paga base)</label>
                        <select id="s_grado" onchange="calcolaStipendio()">
                            <option value="1000">Capo Polizia ($1.000)</option>
                            <option value="1000">Assistente Capo ($1.000)</option>
                            <option value="1000">Vice Capo ($1.000)</option>
                            <option value="1000">Comandante ($1.000)</option>
                            <option value="1000">Capitano II ($1.000)</option>
                            <option value="1000">Capitano I ($1.000)</option>
                            <option value="1000">Tenente II ($1.000)</option>
                            <option value="1000">Tenente I ($1.000)</option>
                            <option value="1000">Detective III ($1.000)</option>
                            <option value="1000">Sergente II ($1.000)</option>
                            <option value="1000">Detective II ($1.000)</option>
                            <option value="1000">Sergente I ($1.000)</option>
                            <option value="1000">Detective I ($1.000)</option>
                            <option value="1000">Agente III ($1.000)</option>
                            <option value="1000">Agente II ($1.000)</option>
                            <option value="1000">Agente I ($1.000)</option>
                            <option value="1000">Recluta ($1.000)</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ore lavorate</label><input type="number" id="s_ore" value="1" min="1" oninput="calcolaStipendio()"></div>
                    <div style="background:#000; padding:15px; text-align:center; border:1px solid var(--success); margin-bottom:15px;">
                        <div id="s_totale" style="font-family:'Orbitron'; font-size:1.5rem; color:var(--success);">$0</div>
                    </div>
                    <button type="submit" style="width:100%; border-color:var(--success);">REGISTRA PAGAMENTO</button>
                </form>
            </div>
            <div class="card" style="grid-column: span 2;">
                <input type="text" class="search-box" placeholder="CERCA PAGAMENTO..." onkeyup="filterTable('stipendiBody', this.value)">
                <table>
                    <thead><tr><th>DATA</th><th>AGENTE</th><th>PERIODO</th><th>IMPORTO</th><th>AZIONI</th></tr></thead>
                    <tbody id="stipendiBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-gestione" class="tab-content hidden">
        <div class="dashboard-grid">
            <div class="card">
                <h3 style="font-family:'Orbitron'; font-size:0.75rem; color:var(--police-accent);">FONDO CASSA LSPD</h3>
                <div class="form-group" style="margin-top:20px;">
                    <label>IMPOSTA NUOVO FONDO ATTUALE ($)</label>
                    <input type="number" id="new_balance" placeholder="Esempio: 500000">
                </div>
                <button onclick="updateGlobalBalance()" style="width:100%; background:var(--police-blue); color:white; margin-top:10px;">AGGIORNA SALDO</button>
            </div>
            <div class="card" style="grid-column: span 2;">
                <h3 style="font-family:'Orbitron'; font-size:0.75rem; color:var(--police-accent);">PAGAMENTI RECENTI</h3>
                <table>
                    <thead><tr><th>DATA</th><th>DESCRIZIONE</th><th>IMPORTO</th></tr></thead>
                    <tbody id="logsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<footer>
    LOS SANTOS POLICE DEPARTMENT &copy; 2026 — PROTOCOLLO FUSION ETERNAL
</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDfIW4GjBZ4QGPvfJtzLAr34VxDRLzcU6M",
        authDomain: "lspd-portal-d34b0.firebaseapp.com",
        projectId: "lspd-portal-d34b0",
        storageBucket: "lspd-portal-d34b0.firebasestorage.app",
        messagingSenderId: "991237515788",
        appId: "1:991237515788:web:302c1b6819947116199c29"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function showNotify(text, color = 'var(--police-blue)') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderLeftColor = color;
        toast.innerText = `[SISTEMA]: ${text}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function openModal(title, bodyHTML, actionsHTML) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = bodyHTML;
        document.getElementById('modalActions').innerHTML = actionsHTML;
        document.getElementById('modalOverlay').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }

    auth.onAuthStateChanged(user => {
        if (user && user.email === "lspd-altocom@fusion.it") {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            refreshAll();
        } else {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });

    async function refreshAll() {
        caricaVeicoli();
        caricaStipendi();
        syncStats();
    }

    async function syncStats() {
        // Saldo
        const conf = await db.collection("config").doc("finance").get();
        const balance = conf.exists ? conf.data().saldo : 0;
        document.getElementById('total_balance').innerText = "$ " + balance.toLocaleString();
        
        // Veicoli
        const vSnap = await db.collection("veicoli_lspd").get();
        document.getElementById('total_vehicles').innerText = vSnap.size;

        // Uscite (Calcolo somma importi in finance_lspd)
        const sSnap = await db.collection("finance_lspd").get();
        let totalExpenses = 0;
        sSnap.forEach(doc => {
            totalExpenses += (doc.data().importo || 0);
        });
        document.getElementById('total_expenses').innerText = "$ " + totalExpenses.toLocaleString();
    }

    function getStatusBadge(stato) {
        let cls = "badge-operativo";
        if(stato === "IN RIPARAZIONE") cls = "badge-riparazione";
        if(stato === "RIMOSSO") cls = "badge-rimosso";
        if(stato === "DISTRUTTO") cls = "badge-distrutto";
        return `<span class="badge ${cls}">${stato}</span>`;
    }

    async function updateGlobalBalance() {
        const val = parseInt(document.getElementById('new_balance').value);
        if(isNaN(val)) return;
        await db.collection("config").doc("finance").set({ saldo: val });
        showNotify("SALDO AGGIORNATO");
        syncStats();
    }

    document.getElementById('veicoloForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await db.collection("veicoli_lspd").add({
            modello: document.getElementById('v_modello').value,
            targa: document.getElementById('v_targa').value,
            agente: document.getElementById('v_agente').value,
            stato: document.getElementById('v_stato').value,
            timestamp: new Date()
        });
        showNotify("VEICOLO REGISTRATO");
        e.target.reset();
        refreshAll();
    });

    async function caricaVeicoli() {
        const snap = await db.collection("veicoli_lspd").orderBy("timestamp", "desc").get();
        const tbody = document.getElementById('veicoliBody');
        tbody.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${d.modello}</td>
                <td style="color:var(--police-accent); font-family:'Orbitron'; font-size:0.7rem;">${d.targa}</td>
                <td>${d.agente || 'NON ASSEGNATO'}</td>
                <td>${getStatusBadge(d.stato)}</td>
                <td><button onclick="editVeicolo('${doc.id}')">MODIFICA</button></td>`;
            tbody.appendChild(tr);
        });
    }

    async function editVeicolo(id) {
        const doc = await db.collection("veicoli_lspd").doc(id).get();
        const d = doc.data();
        const html = `
            <div class="form-group"><label>Modello</label><input type="text" id="edit_v_modello" value="${d.modello}"></div>
            <div class="form-group"><label>Targa</label><input type="text" id="edit_v_targa" value="${d.targa}"></div>
            <div class="form-group"><label>Agente</label><input type="text" id="edit_v_agente" value="${d.agente}"></div>
            <div class="form-group"><label>Stato</label>
                <select id="edit_v_stato">
                    <option value="OPERATIVO" ${d.stato==='OPERATIVO'?'selected':''}>OPERATIVO</option>
                    <option value="IN RIPARAZIONE" ${d.stato==='IN RIPARAZIONE'?'selected':''}>IN RIPARAZIONE</option>
                    <option value="RIMOSSO" ${d.stato==='RIMOSSO'?'selected':''}>RIMOSSO</option>
                    <option value="DISTRUTTO" ${d.stato==='DISTRUTTO'?'selected':''}>DISTRUTTO</option>
                </select>
            </div>`;
        const actions = `<button class="btn-success" onclick="saveEditVeicolo('${id}')">SALVA</button>
                         <button class="btn-danger" onclick="confirmDelete('veicoli_lspd', '${id}')">ELIMINA</button>
                         <button onclick="closeModal()">ANNULLA</button>`;
        openModal("MODIFICA VEICOLO", html, actions);
    }

    async function saveEditVeicolo(id) {
        await db.collection("veicoli_lspd").doc(id).update({
            modello: document.getElementById('edit_v_modello').value,
            targa: document.getElementById('edit_v_targa').value,
            agente: document.getElementById('edit_v_agente').value,
            stato: document.getElementById('edit_v_stato').value
        });
        showNotify("DATI AGGIORNATI");
        closeModal(); refreshAll();
    }

    document.getElementById('stipendioForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = parseInt(document.getElementById('s_totale').innerText.replace('$','').replace(/\./g, '').replace(/,/g, ''));
        const confRef = db.collection("config").doc("finance");
        
        await db.runTransaction(async (transaction) => {
            const confDoc = await transaction.get(confRef);
            const currentBalance = confDoc.data().saldo || 0;
            transaction.update(confRef, { saldo: currentBalance - amount });
            
            const newStipRef = db.collection("finance_lspd").doc();
            transaction.set(newStipRef, {
                agente: document.getElementById('s_agente').value,
                periodo: `${document.getElementById('s_dal').value} / ${document.getElementById('s_al').value}`,
                importo: amount,
                pagaBase: parseInt(document.getElementById('s_grado').value),
                ore: parseInt(document.getElementById('s_ore').value),
                timestamp: new Date()
            });
        });

        showNotify("PAGAMENTO REGISTRATO", "var(--success)");
        e.target.reset();
        refreshAll();
    });

    async function caricaStipendi() {
        const snap = await db.collection("finance_lspd").orderBy("timestamp", "desc").get();
        const tbodyStip = document.getElementById('stipendiBody');
        const tbodyLog = document.getElementById('logsBody');
        tbodyStip.innerHTML = "";
        tbodyLog.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const dateStr = d.timestamp.toDate().toLocaleDateString();
            
            tbodyStip.innerHTML += `
                <tr>
                    <td>${dateStr}</td>
                    <td style="font-weight:bold;">${d.agente}</td>
                    <td>${d.periodo}</td>
                    <td style="color:var(--success); font-weight:bold;">$${d.importo.toLocaleString()}</td>
                    <td><button onclick="editStipendio('${doc.id}')">MODIFICA</button></td>
                </tr>`;

            tbodyLog.innerHTML += `
                <tr>
                    <td>${dateStr}</td>
                    <td>Pagam. Agente: ${d.agente}</td>
                    <td style="color:var(--danger)">-$${d.importo.toLocaleString()}</td>
                </tr>`;
        });
    }

    async function editStipendio(id) {
        const doc = await db.collection("finance_lspd").doc(id).get();
        const d = doc.data();
        
        let dataInizio = "", dataFine = "";
        if (d.periodo && d.periodo.includes(" / ")) {
            const parti = d.periodo.split(" / ");
            dataInizio = parti[0];
            dataFine = parti[1];
        }

        const html = `
            <div class="form-group"><label>Agente</label><input type="text" id="edit_s_agente" value="${d.agente}"></div>
            <div class="form-row">
                <div class="form-group"><label>Dal</label><input type="date" id="edit_s_dal" value="${dataInizio}"></div>
                <div class="form-group"><label>Al</label><input type="date" id="edit_s_al" value="${dataFine}"></div>
            </div>
            <div class="form-group">
                <label>Grado (Paga base)</label>
                <select id="edit_s_grado" onchange="calcolaStipendioEdit()">
                    <option value="5000" ${d.pagaBase == 5000 ? 'selected' : ''}>Capo Polizia ($5.000)</option>
                    <option value="4000" ${d.pagaBase == 4000 ? 'selected' : ''}>Tenente ($4.000)</option>
                    <option value="2500" ${d.pagaBase == 2500 ? 'selected' : ''}>Agente Scelto ($2.500)</option>
                    <option value="1000" ${d.pagaBase == 1000 ? 'selected' : ''}>Recluta ($1.000)</option>
                </select>
            </div>
            <div class="form-group"><label>Ore lavorate</label>
                <input type="number" id="edit_s_ore" value="${d.ore || 1}" min="1" oninput="calcolaStipendioEdit()">
            </div>
            <div style="background:#000; padding:15px; text-align:center; border:1px solid var(--success); margin-bottom:15px;">
                <div id="edit_s_totale" style="font-family:'Orbitron'; font-size:1.5rem; color:var(--success);">$${d.importo.toLocaleString()}</div>
                <input type="hidden" id="old_s_importo" value="${d.importo}">
            </div>`;

        const actions = `
            <button class="btn-success" onclick="saveEditStipendio('${id}')">SALVA E AGGIORNA SALDO</button>
            <button class="btn-danger" onclick="confirmDelete('finance_lspd', '${id}')">ELIMINA</button>
            <button onclick="closeModal()">ANNULLA</button>`;
        
        openModal("MODIFICA PAGAMENTO", html, actions);
    }

    async function saveEditStipendio(id) {
        const textAmt = document.getElementById('edit_s_totale').innerText.replace('$', '').replace(/\./g, '').replace(/,/g, '');
        const newAmt = parseInt(textAmt);
        const oldAmt = parseInt(document.getElementById('old_s_importo').value);
        const diff = oldAmt - newAmt; 

        const confRef = db.collection("config").doc("finance");

        await db.runTransaction(async (transaction) => {
            const confDoc = await transaction.get(confRef);
            const currentBalance = confDoc.data().saldo || 0;
            
            transaction.update(confRef, { saldo: currentBalance + diff });
            transaction.update(db.collection("finance_lspd").doc(id), {
                agente: document.getElementById('edit_s_agente').value,
                periodo: `${document.getElementById('edit_s_dal').value} / ${document.getElementById('edit_s_al').value}`,
                importo: newAmt,
                pagaBase: parseInt(document.getElementById('edit_s_grado').value),
                ore: parseInt(document.getElementById('edit_s_ore').value)
            });
        });

        showNotify("RECORD E SALDO AGGIORNATI");
        closeModal(); 
        refreshAll();
    }

    function confirmDelete(coll, id) {
        const actions = `<button class="btn-danger" onclick="deleteExec('${coll}', '${id}')">SI, ELIMINA</button>
                         <button onclick="closeModal()">ANNULLA</button>`;
        openModal("CONFERMA ELIMINAZIONE", "<p>L'eliminazione sarà definitiva. Continuare?</p>", actions);
    }

    async function deleteExec(coll, id) {
        if (coll === 'finance_lspd') {
            const doc = await db.collection(coll).doc(id).get();
            const amount = doc.data().importo;
            const confRef = db.collection("config").doc("finance");
            const conf = await confRef.get();
            await confRef.update({ saldo: (conf.data().saldo || 0) + amount });
        }
        await db.collection(coll).doc(id).delete();
        showNotify("RECORD ELIMINATO E SALDO RICALCOLATO", "var(--warning)");
        closeModal(); refreshAll();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function filterTable(tbodyId, query) {
        const q = query.toLowerCase();
        const rows = document.getElementById(tbodyId).getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
        }
    }

    function calcolaStipendio() {
        const val = document.getElementById('s_grado').value;
        const ore = document.getElementById('s_ore').value;
        document.getElementById('s_totale').innerText = "$" + (val * ore).toLocaleString();
    }

    function calcolaStipendioEdit() {
        const val = document.getElementById('edit_s_grado').value;
        const ore = document.getElementById('edit_s_ore').value;
        document.getElementById('edit_s_totale').innerText = "$" + (val * ore).toLocaleString();
    }

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('it-IT'); }, 1000);
    
    document.getElementById('loginForm').addEventListener('submit', e => {
        e.preventDefault();
        auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value)
            .catch(() => showNotify("ERRORE LOGIN", "var(--danger)"));
    });

    function logout() { auth.signOut(); }
    window.onload = calcolaStipendio;

</script>

</body>
</html>
